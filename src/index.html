<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https:;">
  <title>YouTube Downloader</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      -webkit-app-region: drag;
    }

    .container {
      padding: 60px 40px 40px;
      max-width: 700px;
      margin: 0 auto;
      -webkit-app-region: no-drag;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #ff6b6b, #feca57);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #8892b0;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .url-input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #2d3748;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 15px;
      transition: all 0.3s;
    }

    .url-input:focus {
      outline: none;
      border-color: #ff6b6b;
      background: rgba(255, 255, 255, 0.08);
    }

    .url-input::placeholder {
      color: #6b7280;
    }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 2px solid #2d3748;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .settings-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
    }

    .folder-path {
      flex: 1;
      font-size: 13px;
      color: #8892b0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .folder-icon {
      width: 20px;
      height: 20px;
      fill: #8892b0;
    }

    .status {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .status.error {
      display: block;
      background: rgba(255, 107, 107, 0.15);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }

    .status.success {
      display: block;
      background: rgba(46, 213, 115, 0.15);
      border: 1px solid rgba(46, 213, 115, 0.3);
      color: #2ed573;
    }

    .status.warning {
      display: block;
      background: rgba(254, 202, 87, 0.15);
      border: 1px solid rgba(254, 202, 87, 0.3);
      color: #feca57;
    }

    .progress-container {
      display: none;
      margin-bottom: 20px;
    }

    .progress-container.active {
      display: block;
    }

    .progress-title {
      font-size: 14px;
      color: #8892b0;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #feca57);
      border-radius: 3px;
      transition: width 0.3s;
      width: 0%;
    }

    .queue-container {
      margin-top: 30px;
    }

    .queue-title {
      font-size: 14px;
      color: #8892b0;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .queue-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 250px;
      overflow-y: auto;
    }

    .queue-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .queue-item-thumb {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      object-fit: cover;
      background: rgba(255, 255, 255, 0.1);
    }

    .queue-item-info {
      flex: 1;
      min-width: 0;
    }

    .queue-item-title {
      font-size: 14px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .queue-item-artist {
      font-size: 12px;
      color: #8892b0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .queue-item-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
    }

    .queue-item-status.pending {
      color: #8892b0;
    }

    .queue-item-status.downloading {
      color: #feca57;
      background: rgba(254, 202, 87, 0.15);
    }

    .queue-item-status.done {
      color: #2ed573;
      background: rgba(46, 213, 115, 0.15);
    }

    .queue-item-status.error {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.15);
    }

    .completed-section {
      margin-top: 30px;
    }

    .completed-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: rgba(46, 213, 115, 0.08);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .completed-item-name {
      font-size: 13px;
      color: #2ed573;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    .format-toggle {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 4px;
    }

    .format-btn {
      flex: 1;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
      color: #8892b0;
    }

    .format-btn:hover {
      color: #fff;
    }

    .format-btn.active {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: #fff;
    }

    .format-btn.active.video {
      background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
    }

    .ipod-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(46, 213, 115, 0.2);
      color: #2ed573;
      font-weight: 500;
    }

    .btn-ipod {
      background: linear-gradient(135deg, #a8e6cf 0%, #3dc1d3 100%);
      color: #1a1a2e;
      font-weight: 600;
    }

    .btn-ipod:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(61, 193, 211, 0.3);
    }

    .btn-ipod:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .completed-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-stop {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
      color: #fff;
    }

    .btn-stop:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }

    .preview-container {
      display: none;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .preview-container.active {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .preview-thumb {
      width: 120px;
      height: 68px;
      border-radius: 8px;
      object-fit: cover;
      background: rgba(255, 255, 255, 0.1);
    }

    .preview-info {
      flex: 1;
      min-width: 0;
    }

    .preview-title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .preview-artist {
      font-size: 13px;
      color: #8892b0;
      margin-bottom: 4px;
    }

    .preview-duration {
      font-size: 12px;
      color: #6b7280;
    }

    .preview-playlist {
      font-size: 12px;
      color: #feca57;
      padding: 4px 10px;
      background: rgba(254, 202, 87, 0.15);
      border-radius: 20px;
      display: inline-block;
      margin-top: 4px;
    }

    .queue-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .queue-title-row .queue-title {
      margin-bottom: 0;
    }

    .queue-item-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-stop-item {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 6px;
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-stop-item:hover {
      background: rgba(255, 107, 107, 0.3);
    }

    .btn-stop-item:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouTube Downloader</h1>
    <p class="subtitle">Download as high-quality M4A or MP4</p>

    <div id="dependencyWarning" class="status warning" style="display: none;">
      Missing dependencies. Please install yt-dlp and ffmpeg:<br>
      <code style="font-size: 12px; display: block; margin-top: 8px;">brew install yt-dlp ffmpeg</code>
    </div>

    <div class="input-group">
      <input type="text" id="urlInput" class="url-input" placeholder="Paste YouTube URL (video or playlist)..." />
      <button id="loadBtn" class="btn btn-secondary">Load</button>
      <button id="downloadBtn" class="btn btn-primary">Download</button>
    </div>

    <div class="format-toggle">
      <button id="formatAudio" class="format-btn active">Audio (M4A)</button>
      <button id="formatVideo" class="format-btn">Video (MP4)</button>
    </div>

    <div id="previewContainer" class="preview-container">
      <img id="previewThumb" class="preview-thumb" src="" alt="">
      <div class="preview-info">
        <div id="previewTitle" class="preview-title"></div>
        <div id="previewArtist" class="preview-artist"></div>
        <div id="previewDuration" class="preview-duration"></div>
        <div id="previewPlaylist" class="preview-playlist" style="display: none;"></div>
      </div>
    </div>

    <div id="ipodFormatRow" class="settings-row" style="display: none;">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox" id="ipodFormat" style="width: 16px; height: 16px;">
        <span style="color: #8892b0; font-size: 13px;">iPod Format (640x480, converts for iTunes sync)</span>
      </label>
    </div>

    <div class="settings-row">
      <svg class="folder-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
      </svg>
      <span id="folderPath" class="folder-path">Loading...</span>
      <button id="changeFolder" class="btn btn-secondary btn-small">Change</button>
    </div>

    <div id="ipodStatus" class="settings-row" style="display: none;">
      <svg class="folder-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
      </svg>
      <span id="ipodInfo" class="folder-path">iPod connected</span>
      <span class="ipod-badge">Ready</span>
    </div>

    <div id="status" class="status"></div>

    <div id="progressContainer" class="progress-container">
      <div id="progressTitle" class="progress-title">Downloading...</div>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>

    <div id="queueContainer" class="queue-container" style="display: none;">
      <div class="queue-title">Download Queue</div>
      <div id="queueList" class="queue-list"></div>
    </div>

    <div id="completedSection" class="completed-section" style="display: none;">
      <div class="queue-title-row">
        <div class="queue-title">Completed</div>
        <button id="clearCompleted" class="btn btn-secondary btn-small">Clear</button>
      </div>
      <div id="completedList"></div>
    </div>
  </div>

  <script>
    const urlInput = document.getElementById('urlInput');
    const loadBtn = document.getElementById('loadBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const folderPath = document.getElementById('folderPath');
    const changeFolder = document.getElementById('changeFolder');
    const status = document.getElementById('status');
    const progressContainer = document.getElementById('progressContainer');
    const progressTitle = document.getElementById('progressTitle');
    const progressFill = document.getElementById('progressFill');
    const queueContainer = document.getElementById('queueContainer');
    const queueList = document.getElementById('queueList');
    const completedSection = document.getElementById('completedSection');
    const completedList = document.getElementById('completedList');
    const clearCompletedBtn = document.getElementById('clearCompleted');
    const dependencyWarning = document.getElementById('dependencyWarning');
    const formatAudio = document.getElementById('formatAudio');
    const formatVideo = document.getElementById('formatVideo');
    const previewContainer = document.getElementById('previewContainer');
    const previewThumb = document.getElementById('previewThumb');
    const previewTitle = document.getElementById('previewTitle');
    const previewArtist = document.getElementById('previewArtist');
    const previewDuration = document.getElementById('previewDuration');
    const previewPlaylist = document.getElementById('previewPlaylist');

    let isDownloading = false;
    let queue = [];
    let completed = [];
    let currentDownloadPath = '';
    let currentFormat = 'audio'; // 'audio' or 'video'
    let ipodConnected = false;
    let ipodPath = '';
    let ipodFreeSpace = 0;
    let loadedInfo = null; // Store loaded info for download

    const ipodFormatRow = document.getElementById('ipodFormatRow');
    const ipodFormatCheckbox = document.getElementById('ipodFormat');

    // Format toggle
    formatAudio.addEventListener('click', () => {
      currentFormat = 'audio';
      formatAudio.classList.add('active');
      formatAudio.classList.remove('video');
      formatVideo.classList.remove('active');
      ipodFormatRow.style.display = 'none';
    });

    formatVideo.addEventListener('click', () => {
      currentFormat = 'video';
      formatVideo.classList.add('active', 'video');
      formatAudio.classList.remove('active');
      ipodFormatRow.style.display = 'flex';
    });

    // Check iPod status
    async function checkIpodStatus() {
      try {
        const result = await window.api.checkIpod();
        ipodConnected = result.connected;
        if (result.connected) {
          ipodPath = result.path;
          ipodFreeSpace = result.freeSpace;
          const freeGB = (result.freeSpace / (1024 * 1024 * 1024)).toFixed(1);
          document.getElementById('ipodStatus').style.display = 'flex';
          document.getElementById('ipodInfo').textContent = `iPod connected (${freeGB}GB free)`;
        } else {
          document.getElementById('ipodStatus').style.display = 'none';
        }
        // Re-render completed list to show/hide iPod buttons
        showCompleted();
      } catch (e) {
        ipodConnected = false;
        document.getElementById('ipodStatus').style.display = 'none';
      }
    }

    // Initialize
    async function init() {
      currentDownloadPath = await window.api.getDownloadPath();
      folderPath.textContent = currentDownloadPath;

      const deps = await window.api.checkDependencies();
      if (!deps.ytdlp || !deps.ffmpeg) {
        dependencyWarning.style.display = 'block';
        downloadBtn.disabled = true;
      }

      // Check iPod on startup and periodically
      checkIpodStatus();
      setInterval(checkIpodStatus, 5000); // Check every 5 seconds
    }
    init();

    // Progress listener
    window.api.onProgress((data) => {
      progressFill.style.width = `${data.percent}%`;
      if (data.status) {
        progressTitle.textContent = data.status;
      } else {
        progressTitle.textContent = `Downloading: ${data.title} (${Math.round(data.percent)}%)`;
      }
    });

    // Change folder
    changeFolder.addEventListener('click', async () => {
      const newPath = await window.api.selectFolder();
      if (newPath) {
        currentDownloadPath = newPath;
        folderPath.textContent = newPath;
      }
    });

    // Format duration
    function formatDuration(seconds) {
      if (!seconds) return '';
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Load button - preview before download
    loadBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) {
        showStatus('Please enter a YouTube URL', 'error');
        return;
      }

      if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
        showStatus('Please enter a valid YouTube URL', 'error');
        return;
      }

      loadBtn.disabled = true;
      loadBtn.innerHTML = '<span class="loading-spinner"></span>';
      status.style.display = 'none';
      previewContainer.classList.remove('active');

      try {
        const info = await window.api.getInfo(url);
        loadedInfo = info;

        if (info.type === 'playlist') {
          const count = info.data.length;
          previewThumb.src = info.data[0]?.thumbnail || '';
          previewTitle.textContent = info.data[0]?.playlist_title || 'Playlist';
          previewArtist.textContent = info.data[0]?.uploader || info.data[0]?.channel || '';
          previewDuration.textContent = '';
          previewPlaylist.textContent = `${count} ${count === 1 ? 'track' : 'tracks'}`;
          previewPlaylist.style.display = 'inline-block';
        } else {
          const item = info.data;
          const thumb = item.thumbnail || (item.thumbnails && item.thumbnails[item.thumbnails.length - 1]?.url);
          previewThumb.src = thumb || '';
          previewTitle.textContent = item.title || 'Unknown';
          previewArtist.textContent = item.artist || item.uploader || item.channel || '';
          previewDuration.textContent = formatDuration(item.duration);
          previewPlaylist.style.display = 'none';
        }

        previewContainer.classList.add('active');
        showStatus('Ready to download', 'success');
      } catch (err) {
        showStatus(`Error: ${err.message}`, 'error');
        loadedInfo = null;
      }

      loadBtn.disabled = false;
      loadBtn.textContent = 'Load';
    });

    // Clear completed button
    clearCompletedBtn.addEventListener('click', () => {
      completed = [];
      completedList.innerHTML = '';
      completedSection.style.display = 'none';
    });

    // Download button
    downloadBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) {
        showStatus('Please enter a YouTube URL', 'error');
        return;
      }

      if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
        showStatus('Please enter a valid YouTube URL', 'error');
        return;
      }

      downloadBtn.disabled = true;
      downloadBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';
      status.style.display = 'none';

      try {
        const info = await window.api.getInfo(url);
        let newItems = [];

        if (info.type === 'playlist') {
          // Add all tracks to queue
          newItems = info.data.map((item, index) => ({
            id: item.id,
            url: item.url || `https://www.youtube.com/watch?v=${item.id}`,
            title: item.title || `Track ${index + 1}`,
            artist: item.uploader || item.channel || 'Unknown',
            thumbnail: item.thumbnail || (item.thumbnails && item.thumbnails[0]?.url),
            status: 'pending'
          }));
        } else {
          // Single track
          const item = info.data;
          newItems = [{
            id: item.id,
            url: url,
            title: item.title || 'Unknown',
            artist: item.artist || item.uploader || item.channel || 'Unknown',
            thumbnail: item.thumbnail || (item.thumbnails && item.thumbnails[item.thumbnails.length - 1]?.url),
            status: 'pending'
          }];
        }

        // Add to existing queue
        queue = queue.concat(newItems);
        urlInput.value = '';
        previewContainer.classList.remove('active');
        loadedInfo = null;

        showQueue();
        showStatus(`Added ${newItems.length} item${newItems.length > 1 ? 's' : ''} to queue`, 'success');

        // Start processing if not already downloading
        if (!isDownloading) {
          downloadQueue();
        }
      } catch (err) {
        showStatus(`Error: ${err.message}`, 'error');
      }

      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download';
    });

    async function downloadQueue() {
      if (isDownloading) return; // Prevent concurrent calls
      isDownloading = true;
      progressContainer.classList.add('active');

      // Process queue items - find next pending item
      while (true) {
        const pendingIndex = queue.findIndex(item => item.status === 'pending');
        if (pendingIndex === -1) break; // No more pending items

        const item = queue[pendingIndex];
        item.status = 'downloading';
        updateQueueUI();

        try {
          progressFill.style.width = '0%';
          progressTitle.textContent = `Downloading: ${item.title}`;

          const result = currentFormat === 'video'
            ? await window.api.downloadVideo(item.url, currentDownloadPath, ipodFormatCheckbox.checked)
            : await window.api.downloadTrack(item.url, currentDownloadPath);
          item.status = 'done';

          completed.push({
            ...item,
            file: result.file,
            artist: result.artist,
            album: result.album
          });

          updateQueueUI();
          showCompleted();
        } catch (err) {
          item.status = 'error';
          item.error = err.message;
          updateQueueUI();
        }
      }

      isDownloading = false;
      progressContainer.classList.remove('active');

      // Clean up finished items from queue after a short delay
      const successCount = queue.filter(i => i.status === 'done').length;
      const errorCount = queue.filter(i => i.status === 'error').length;

      if (successCount > 0 || errorCount > 0) {
        const itemType = currentFormat === 'video' ? 'video' : 'track';
        const itemTypePlural = currentFormat === 'video' ? 'videos' : 'tracks';

        if (errorCount === 0) {
          showStatus(`Successfully downloaded ${successCount} ${successCount > 1 ? itemTypePlural : itemType}!`, 'success');
        } else {
          showStatus(`Downloaded ${successCount} ${successCount > 1 ? itemTypePlural : itemType}, ${errorCount} failed`, 'warning');
        }

        // Remove completed/errored items from queue after delay
        setTimeout(() => {
          queue = queue.filter(item => item.status === 'pending');
          if (queue.length === 0) {
            queueContainer.style.display = 'none';
          } else {
            updateQueueUI();
          }
        }, 2000);
      }
    }

    function showQueue() {
      queueContainer.style.display = 'block';
      updateQueueUI();
    }

    function updateQueueUI() {
      queueList.innerHTML = queue.map((item, idx) => `
        <div class="queue-item">
          ${item.thumbnail ? `<img class="queue-item-thumb" src="${item.thumbnail}" alt="">` : '<div class="queue-item-thumb"></div>'}
          <div class="queue-item-info">
            <div class="queue-item-title">${escapeHtml(item.title)}</div>
            <div class="queue-item-artist">${escapeHtml(item.artist)}</div>
          </div>
          <div class="queue-item-actions">
            <span class="queue-item-status ${item.status}">${getStatusText(item.status)}</span>
            ${item.status === 'downloading' || item.status === 'pending' ? `<button class="btn-stop-item" data-idx="${idx}">Stop</button>` : ''}
          </div>
        </div>
      `).join('');

      // Add click handlers for stop buttons
      queueList.querySelectorAll('.btn-stop-item').forEach(btn => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.dataset.idx);
          const item = queue[idx];
          if (!item) return;

          if (item.status === 'downloading') {
            // Stop current download
            btn.disabled = true;
            btn.textContent = 'Stopping...';
            try {
              await window.api.stopDownload();
              item.status = 'error';
              item.error = 'Cancelled';
              updateQueueUI();
            } catch (err) {
              console.error('Error stopping download:', err);
            }
          } else if (item.status === 'pending') {
            // Remove from queue
            queue.splice(idx, 1);
            updateQueueUI();
            if (queue.length === 0) {
              queueContainer.style.display = 'none';
            }
          }
        });
      });
    }

    function showCompleted() {
      if (completed.length === 0) return;
      completedSection.style.display = 'block';

      completedList.innerHTML = completed.map((item, idx) => {
        const isAudio = item.file && item.file.endsWith('.m4a');
        const isVideo = item.file && item.file.endsWith('.mp4');
        const showIpodBtn = ipodConnected && (isAudio || isVideo);
        const ipodBtnClass = isVideo ? 'video-to-ipod' : 'copy-to-ipod';
        const ipodBtnText = isVideo ? 'Convert to iPod' : 'Copy to iPod';

        return `
          <div class="completed-item">
            <span class="completed-item-name">${escapeHtml(item.artist)} - ${escapeHtml(item.title)}</span>
            <div class="completed-buttons">
              ${showIpodBtn ? `<button class="btn btn-ipod btn-small ${ipodBtnClass}" data-idx="${idx}">${ipodBtnText}</button>` : ''}
              <button class="btn btn-secondary btn-small show-in-finder" data-idx="${idx}">Show in Finder</button>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers for Show in Finder
      completedList.querySelectorAll('.show-in-finder').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.dataset.idx);
          if (completed[idx] && completed[idx].file) {
            window.api.openFolder(completed[idx].file);
          }
        });
      });

      // Add click handlers for Copy to iPod (audio)
      completedList.querySelectorAll('.copy-to-ipod').forEach(btn => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.dataset.idx);
          const item = completed[idx];
          if (!item || !item.file) return;

          btn.disabled = true;
          btn.textContent = 'Copying...';

          try {
            await window.api.copyToIpod(item.file, item.artist, item.title);
            btn.textContent = 'Copied!';
            btn.style.background = 'rgba(46, 213, 115, 0.3)';
            setTimeout(() => {
              btn.textContent = 'Copy to iPod';
              btn.disabled = false;
              btn.style.background = '';
            }, 2000);
          } catch (err) {
            btn.textContent = 'Failed';
            btn.style.background = 'rgba(255, 107, 107, 0.3)';
            setTimeout(() => {
              btn.textContent = 'Copy to iPod';
              btn.disabled = false;
              btn.style.background = '';
            }, 2000);
          }
        });
      });

      // Add click handlers for Convert to iPod (video)
      completedList.querySelectorAll('.video-to-ipod').forEach(btn => {
        btn.addEventListener('click', async () => {
          const idx = parseInt(btn.dataset.idx);
          const item = completed[idx];
          if (!item || !item.file) return;

          btn.disabled = true;
          btn.textContent = 'Converting...';

          try {
            await window.api.videoToIpod(item.file, item.artist, item.title);
            btn.textContent = 'Done!';
            btn.style.background = 'rgba(46, 213, 115, 0.3)';
            setTimeout(() => {
              btn.textContent = 'Convert to iPod';
              btn.disabled = false;
              btn.style.background = '';
            }, 2000);
          } catch (err) {
            btn.textContent = 'Failed';
            btn.style.background = 'rgba(255, 107, 107, 0.3)';
            setTimeout(() => {
              btn.textContent = 'Convert to iPod';
              btn.disabled = false;
              btn.style.background = '';
            }, 2000);
          }
        });
      });
    }

    function showStatus(message, type) {
      status.textContent = message;
      status.className = 'status ' + type;
    }

    function getStatusText(s) {
      const map = {
        pending: 'Waiting',
        downloading: 'Downloading',
        done: 'Done',
        error: 'Failed'
      };
      return map[s] || s;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[c]));
    }

    // Allow paste with keyboard
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !isDownloading) {
        downloadBtn.click();
      }
    });
  </script>
</body>
</html>
